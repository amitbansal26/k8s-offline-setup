---
- name: Install Calico CNI plugin
  block:
    - name: Copy Calico manifest to master node
      copy:
        src: "{{ target_package_dir }}/calico.yaml"
        dest: /tmp/calico.yaml
        remote_src: yes
    
    - name: Modify Calico manifest for pod network CIDR
      replace:
        path: /tmp/calico.yaml
        regexp: '192\.168\.0\.0/16'
        replace: "{{ pod_network_cidr }}"
    
    - name: Apply Calico manifest
      shell: kubectl apply -f /tmp/calico.yaml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
    
    - name: Wait for Calico pods to be ready
      shell: kubectl wait --for=condition=Ready pods --all -n kube-system --timeout=300s
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      ignore_errors: yes
  when: cni_plugin == "calico"

- name: Install Flannel CNI plugin
  block:
    - name: Copy Flannel manifest to master node
      copy:
        src: "{{ target_package_dir }}/kube-flannel.yml"
        dest: /tmp/kube-flannel.yml
        remote_src: yes
    
    - name: Apply Flannel manifest
      shell: kubectl apply -f /tmp/kube-flannel.yml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
    
    - name: Wait for Flannel pods to be ready
      shell: kubectl wait --for=condition=Ready pods --all -n kube-flannel --timeout=300s
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      ignore_errors: yes
  when: cni_plugin == "flannel"

- name: Verify all pods are running
  shell: kubectl get pods --all-namespaces
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: all_pods

- name: Display pod status
  debug:
    var: all_pods.stdout_lines
