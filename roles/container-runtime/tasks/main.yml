---
- name: Extract containerd binary
  unarchive:
    src: "{{ target_package_dir }}/containerd-{{ containerd_version }}-linux-amd64.tar.gz"
    dest: /usr/local
    remote_src: yes
    creates: /usr/local/bin/containerd

- name: Copy runc binary
  copy:
    src: "{{ target_package_dir }}/runc.amd64"
    dest: /usr/local/sbin/runc
    mode: '0755'
    remote_src: yes

- name: Extract CNI plugins
  unarchive:
    src: "{{ target_package_dir }}/cni-plugins-linux-amd64-v1.3.0.tgz"
    dest: /opt/cni/bin
    remote_src: yes
    creates: /opt/cni/bin/bridge

- name: Create containerd systemd service
  copy:
    content: |
      [Unit]
      Description=containerd container runtime
      Documentation=https://containerd.io
      After=network.target local-fs.target

      [Service]
      ExecStartPre=-/sbin/modprobe overlay
      ExecStart=/usr/local/bin/containerd
      Type=notify
      Delegate=yes
      KillMode=process
      Restart=always
      RestartSec=5
      LimitNPROC=infinity
      LimitCORE=infinity
      LimitNOFILE=infinity
      TasksMax=infinity
      OOMScoreAdjust=-999

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/containerd.service
    mode: '0644'

- name: Create containerd configuration
  shell: |
    /usr/local/bin/containerd config default > /etc/containerd/config.toml
  args:
    creates: /etc/containerd/config.toml

- name: Configure containerd to use systemd cgroup driver
  lineinfile:
    path: /etc/containerd/config.toml
    regexp: '^\s*SystemdCgroup\s*='
    line: '            SystemdCgroup = true'
    insertafter: '^\s*\[plugins\."io\.containerd\.grpc\.v1\.cri"\.containerd\.runtimes\.runc\.options\]'

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Enable and start containerd
  systemd:
    name: containerd
    state: started
    enabled: yes

- name: Wait for containerd to be ready
  wait_for:
    path: /run/containerd/containerd.sock
    timeout: 60
